# 邮件告警监听插件

一个用于监听 SMTP 邮件告警并通过主动消息接口发送到 QQ 群的 LangBot 插件。

## 功能特性

- 📧 **SMTP 邮件监听**：监听指定端口接收邮件告警消息
- 🔓 **多编码支持**：支持 Base64 和 Quoted-printable 编码解码
- 📱 **QQ 群通知**：自动转发告警到指定 QQ 群
- 🔧 **配置灵活**：支持插件配置和环境变量配置
- 🎯 **智能解析**：自动提取设备、接口、状态等关键信息
- 🌐 **中文支持**：完整支持中文邮件内容解析

## 项目结构

```
SnmpPlugin/
├── main.py                          # 插件主入口
├── manifest.yaml                    # 插件清单文件
├── README.md                        # 项目说明文档
├── components/
│   ├── __init__.py
│   ├── commands/                    # 命令组件
│   │   ├── __init__.py
│   │   ├── snmp_status.py          # 插件状态查询命令
│   │   └── snmp_status.yaml
│   ├── event_listener/             # 事件监听器
│   │   ├── __init__.py
│   │   ├── default.py              # SMTP 邮件监听器
│   │   └── default.yaml
│   └── utils/                      # 工具类
│       ├── __init__.py
│       └── message_helper.py       # 消息发送辅助类
```

## 配置说明

### 1. 插件配置

在 LangBot 管理界面中配置插件：

- **default_group_id**: 默认 QQ 群号（必填）

### 2. 环境变量配置

在 `.env` 文件中设置：

```bash
SMTP_DEFAULT_GROUP_ID=你的实际QQ群号
SMTP_PORT=1162
```

配置优先级：插件配置 > 环境变量 > 默认值

## 使用方法

### 1. 查看插件状态

使用命令查看插件运行状态：
```
!snmp_status
# 或
!status
```

### 2. 配置网管系统

在网络管理系统中配置邮件告警：

- **SMTP 服务器**：你的服务器地址
- **端口**：1162
- **认证**：无需认证
- **发件人**：可任意配置（如：gaojing_bot@qq.com）
- **收件人**：你的 QQ 邮箱地址

### 3. 告警消息格式

插件会自动解析邮件内容，提取关键信息：

```
【设备告警】

时间：2025-11-15 18:33:22
告警内容：设备: 核心路由器(172.16.2.3), 状态: 链路UP
详情: 接口Ten-GigabitEthernet2/0/2/1的状态UP。 接口描述：to_jingxiang_switch
```

## 技术特点

### 邮件解析能力

1. **多编码支持**：
   - Base64 编码自动解码
   - Quoted-printable 编码自动解码
   - MIME 头部编码解码

2. **智能信息提取**：
   - 自动识别告警源（设备名称和IP）
   - 提取告警名称（状态信息）
   - 解析告警描述（包含具体接口信息）
   - 提取接口描述信息

3. **协议兼容**：
   - 标准 SMTP 协议支持
   - 支持多行邮件内容
   - 正确处理邮件头部和正文分离

### 架构设计

- **模块化设计**：监听器和解析器分离
- **错误处理**：完善的异常处理和日志记录
- **性能优化**：异步处理，避免阻塞
- **扩展性**：易于添加新的邮件格式支持

## 依赖项

- Python 3.7+
- LangBot 框架
- 标准库：socket, re, base64, quopri, datetime

## 注意事项

1. **端口权限**：默认监听 1162 端口，确保有权限绑定
2. **网络配置**：确保防火墙允许相应端口的 TCP 流量
3. **QQ 机器人**：需要配置可用的 QQ 机器人实例
4. **权限要求**：插件需要发送消息的权限
5. **邮件格式**：支持标准邮件格式，建议在网管系统中启用告警描述字段

## 更新日志

### v2.0.0 (邮件版本)
- ✅ 从 SNMP Trap 迁移到 SMTP 邮件监听
- ✅ 新增多编码邮件解析支持
- ✅ 智能提取设备、接口、状态信息
- ✅ 优化消息格式，包含详细信息
- ✅ 完善错误处理和日志记录
- ✅ 删除 SNMP 相关代码，简化项目结构
