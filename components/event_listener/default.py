# Auto generated by LangBot Plugin SDK.
# Please refer to https://docs.langbot.app/en/plugin/dev/tutor.html for more details.
from __future__ import annotations

from langbot_plugin.api.definition.components.common.event_listener import EventListener
from langbot_plugin.api.entities import events, context
import logging
from typing import Dict, Any
from datetime import datetime

# å¯¼å…¥SNMP Trapæ¥æ”¶æœåŠ¡
import sys
import os
sys.path.append(os.path.join(os.path.dirname(__file__), '..', 'services'))
from simple_trap_receiver import SimpleTrapReceiver

# å¯¼å…¥æ¶ˆæ¯è¾…åŠ©å·¥å…·
from ..utils.message_helper import MessageHelper

# è®¾ç½®æ—¥å¿—
logger = logging.getLogger(__name__)


class DefaultEventListener(EventListener):

    def __init__(self):
        super().__init__()
        # é»˜è®¤ç¾¤ç»„IDï¼Œå°†é€šè¿‡æ’ä»¶é…ç½®è®¾ç½®
        self.default_group_id = None
        self.trap_count = 0
        # SNMP Trapæ¥æ”¶å™¨
        self.snmp_receiver = None

    async def initialize(self):
        await super().initialize()

        # ä½¿ç”¨æ¶ˆæ¯è¾…åŠ©å·¥å…·è·å–ç¾¤ç»„ID
        self.default_group_id = await MessageHelper.get_group_id(self.plugin)

        # åˆå§‹åŒ–SNMP Trapæ¥æ”¶å™¨
        await self._init_snmp_receiver()

        print(f"ğŸ”§ SNMP Trap ç›‘å¬å™¨å·²åˆå§‹åŒ–")
        print(f"ğŸ“± é»˜è®¤ QQ ç¾¤ ID: {self.default_group_id}")
        print(f"ğŸ¯ å¼€å§‹ç›‘å¬ SNMP ç›¸å…³æ¶ˆæ¯...")

        # ç›‘å¬ç§èŠæ¶ˆæ¯
        @self.handler(events.PersonMessageReceived)
        async def handle_person_message(event_context: context.EventContext):
            """å¤„ç†ç§èŠæ¶ˆæ¯äº‹ä»¶"""
            print("="*50)
            print("ğŸ” æ”¶åˆ°ç§èŠæ¶ˆæ¯äº‹ä»¶:")
            print(f"äº‹ä»¶ç±»å‹: {type(event_context.event).__name__}")
            print(f"å‘é€è€…ID: {event_context.event.sender_id}")

            # æå–æ¶ˆæ¯å†…å®¹
            message_text = ""
            for msg in event_context.event.message_chain:
                if hasattr(msg, 'text'):
                    message_text += msg.text

            print(f"æ¶ˆæ¯å†…å®¹: {message_text}")

            # æ£€æŸ¥æ˜¯å¦åŒ…å« SNMP ç›¸å…³å†…å®¹
            if self._is_snmp_related(message_text):
                print("ğŸš¨ æ£€æµ‹åˆ°å¯èƒ½çš„ SNMP ç›¸å…³æ¶ˆæ¯!")
                await self._process_snmp_trap_message(message_text, "person", event_context.event.sender_id)

            print("="*50)

        # ç›‘å¬ç¾¤æ¶ˆæ¯
        @self.handler(events.GroupMessageReceived)
        async def handle_group_message(event_context: context.EventContext):
            """å¤„ç†ç¾¤æ¶ˆæ¯äº‹ä»¶"""
            print("="*50)
            print("ğŸ” æ”¶åˆ°ç¾¤æ¶ˆæ¯äº‹ä»¶:")

            # æå–æ¶ˆæ¯å†…å®¹
            message_text = ""
            for msg in event_context.event.message_chain:
                if hasattr(msg, 'text'):
                    message_text += msg.text

            print(f"æ¶ˆæ¯å†…å®¹: {message_text}")

            # æ£€æŸ¥æ˜¯å¦åŒ…å« SNMP ç›¸å…³å†…å®¹
            if self._is_snmp_related(message_text):
                print("ğŸš¨ æ£€æµ‹åˆ°å¯èƒ½çš„ SNMP ç›¸å…³æ¶ˆæ¯!")
                group_id = getattr(event_context.event, 'group_id', self.default_group_id)
                await self._process_snmp_trap_message(message_text, "group", group_id, event_context.event.group_id)

            print("="*50)

        # å°è¯•ç›‘å¬å…¶ä»–å¯èƒ½çš„äº‹ä»¶ç±»å‹ï¼ˆå¦‚ç³»ç»Ÿäº‹ä»¶ï¼‰
        try:
            # è¿™é‡Œå¯ä»¥æ ¹æ®éœ€è¦ç›‘å¬å…¶ä»–ç±»å‹çš„äº‹ä»¶
            pass
        except:
            pass

        logger.info("EventListener åˆå§‹åŒ–å®Œæˆï¼Œå¼€å§‹ç›‘å¬ SNMP Trap ç›¸å…³äº‹ä»¶...")

    def _is_snmp_related(self, message_text: str) -> bool:
        """æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦ä¸ SNMP ç›¸å…³"""
        if not message_text:
            return False

        snmp_keywords = [
            'snmp', 'trap', 'oid', 'mib', 'cisco', 'juniper', 'huawei',
            'h3c', 'aruba', 'fortinet', 'paloalto', 'checkpoint',
            'å‘Šè­¦', 'alert', 'critical', 'warning', 'error',
            'down', 'up', 'interface', 'cpu', 'memory', 'disk'
        ]

        message_lower = message_text.lower()
        return any(keyword in message_lower for keyword in snmp_keywords)

    async def _process_snmp_trap_message(self, message: str, msg_type: str, target_id: str, group_id: str = None):
        """å¤„ç† SNMP Trap æ¶ˆæ¯å¹¶å‘é€åˆ° QQ ç¾¤"""
        try:
            self.trap_count += 1

            # ç®€å•è§£ææ¶ˆæ¯å†…å®¹ï¼ˆå®é™…é¡¹ç›®ä¸­å¯èƒ½éœ€è¦æ›´å¤æ‚çš„è§£æï¼‰
            parsed_trap = self._parse_snmp_message(message)

            # æ„å»ºå‘Šè­¦æ¶ˆæ¯
            alert_message = MessageHelper.format_trap_message(parsed_trap, "ç½‘ç»œå‘Šè­¦")

            # ä½¿ç”¨æ¶ˆæ¯è¾…åŠ©å·¥å…·å‘é€åˆ°QQç¾¤
            await MessageHelper.send_to_qq_group(
                self.plugin,
                alert_message,
                group_id or self.default_group_id,
                "SNMP Trap"
            )

            print(f"âœ… SNMP Trap å¤„ç†å®Œæˆ (ç¬¬ {self.trap_count} æ¬¡)")

        except Exception as e:
            logger.error(f"å¤„ç† SNMP Trap æ¶ˆæ¯æ—¶å‡ºé”™: {e}")
            print(f"âŒ å¤„ç† SNMP Trap å¤±è´¥: {e}")

    def _parse_snmp_message(self, message: str) -> Dict[str, Any]:
        """è§£æ SNMP Trap æ¶ˆæ¯ï¼ˆç®€å•ç‰ˆæœ¬ï¼‰"""
        # è¿™é‡Œæ˜¯ç®€åŒ–ç‰ˆè§£æï¼Œå®é™…é¡¹ç›®ä¸­å¯èƒ½éœ€è¦è§£æ SNMP åè®®æ•°æ®
        return {
            'raw_message': message,
            'timestamp': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
            'trap_count': self.trap_count,
            'message_type': 'simple_parse',
            'severity': self._extract_severity(message),
            'hostname': self._extract_hostname(message)
        }

    def _extract_severity(self, message: str) -> str:
        """æå–å‘Šè­¦çº§åˆ«"""
        message_lower = message.lower()
        if any(word in message_lower for word in ['critical', 'critical', 'ä¸¥é‡']):
            return 'Critical'
        elif any(word in message_lower for word in ['warning', 'warn', 'è­¦å‘Š']):
            return 'Warning'
        elif any(word in message_lower for word in ['info', 'info', 'ä¿¡æ¯']):
            return 'Info'
        else:
            return 'Unknown'

    def _extract_hostname(self, message: str) -> str:
        """æå–ä¸»æœºå"""
        # ç®€å•çš„ä¸»æœºåæå–ï¼Œå®é™…é¡¹ç›®ä¸­å¯èƒ½éœ€è¦æ›´å¤æ‚çš„è§£æ
        import re

        # å°è¯•åŒ¹é… IP åœ°å€
        ip_pattern = r'\b(?:[0-9]{1,3}\.){3}[0-9]{1,3}\b'
        ip_match = re.search(ip_pattern, message)
        if ip_match:
            return ip_match.group()

        # å°è¯•æå–å¯èƒ½çš„ä¸»æœºå
        host_pattern = r'\b(?:[a-zA-Z0-9-]+\.(?:com|net|org|gov|edu|cn))\b'
        host_match = re.search(host_pattern, message)
        if host_match:
            return host_match.group()

        return "Unknown"

  
    async def _init_snmp_receiver(self):
        """åˆå§‹åŒ–SNMP Trapæ¥æ”¶å™¨"""
        try:
            print("ğŸ”Œ æ­£åœ¨åˆå§‹åŒ–SNMP Trapæ¥æ”¶å™¨...")

            # åˆ›å»ºSNMP Trapæ¥æ”¶å™¨ï¼Œç›‘å¬ç«¯å£1162
            self.snmp_receiver = SimpleTrapReceiver(port=1162, host='0.0.0.0')  # ç›‘å¬æ‰€æœ‰ç½‘ç»œæ¥å£
            self.snmp_receiver.set_callback(self._handle_snmp_trap)

            # ç›´æ¥å¯åŠ¨æ¥æ”¶å™¨ï¼ˆåŒæ­¥æ–¹å¼ï¼‰
            self.snmp_receiver.start()
            print(f"âœ… SNMP Trapæ¥æ”¶å™¨å·²æˆåŠŸå¯åŠ¨ï¼Œç›‘å¬ç«¯å£: 1162")
            print(f"ğŸŒ ç›‘å¬åœ°å€: 0.0.0.0:1162")
            print(f"ğŸ“¡ ç­‰å¾…æ¥æ”¶SNMP Trapæ¶ˆæ¯...")

        except Exception as e:
            print(f"âŒ åˆå§‹åŒ–SNMP Trapæ¥æ”¶å™¨å¤±è´¥: {e}")
            logger.error(f"åˆå§‹åŒ–SNMP Trapæ¥æ”¶å™¨å¤±è´¥: {e}")
            self.snmp_receiver = None

    async def _run_snmp_receiver(self):
        """åœ¨åå°è¿è¡ŒSNMPæ¥æ”¶å™¨"""
        try:
            if self.snmp_receiver:
                await self.snmp_receiver.start()
        except asyncio.CancelledError:
            print("ğŸ›‘ SNMP Trapæ¥æ”¶å™¨ä»»åŠ¡è¢«å–æ¶ˆ")
        except Exception as e:
            print(f"âŒ SNMP Trapæ¥æ”¶å™¨è¿è¡Œå‡ºé”™: {e}")
            logger.error(f"SNMP Trapæ¥æ”¶å™¨è¿è¡Œå‡ºé”™: {e}")

    async def _handle_snmp_trap(self, trap_info: Dict[str, Any]):
        """å¤„ç†æ¥æ”¶åˆ°çš„SNMP Trap"""
        try:
            self.trap_count += 1
            trap_info['trap_count'] = self.trap_count

            print("\n" + "="*60)
            print(f"ğŸš¨ **æ”¶åˆ°SNMP Trap** ğŸš¨")
            print(f"ğŸ“Š **Trapåºå·**: #{self.trap_count}")
            print(f"â° **æ¥æ”¶æ—¶é—´**: {trap_info.get('timestamp')}")
            print(f"ğŸŒ **æ¥æºIP**: {trap_info.get('source_ip')}")
            print(f"ğŸ“¡ **æ¥æºç«¯å£**: {trap_info.get('source_port')}")
            print(f"ğŸ“ **æ•°æ®é•¿åº¦**: {trap_info.get('data_length')} å­—èŠ‚")

            if trap_info.get('snmp_version'):
                print(f"ğŸ”§ **SNMPç‰ˆæœ¬**: {trap_info.get('snmp_version')}")

            if trap_info.get('readable_content'):
                print(f"ğŸ“ **å¯è¯»å†…å®¹**: {trap_info.get('readable_content')}")

            if trap_info.get('parsed'):
                print("âœ… **è§£æçŠ¶æ€**: æˆåŠŸè§£æ")
            else:
                print("âš ï¸ **è§£æçŠ¶æ€**: æœªèƒ½å®Œå…¨è§£æï¼ˆæ˜¾ç¤ºåŸå§‹æ•°æ®å‰100å­—ç¬¦ï¼‰")
                print(f"ğŸ” **åŸå§‹æ•°æ®**: {trap_info.get('raw_data')}")

            print("="*60)

            # å‘é€å‘Šè­¦åˆ°QQç¾¤
            alert_message = MessageHelper.format_trap_message(trap_info, "SNMP Trap")
            await MessageHelper.send_to_qq_group(
                self.plugin,
                alert_message,
                self.default_group_id,
                "SNMP Trap"
            )

            logger.info(f"SNMP Trap #{self.trap_count} å¤„ç†å®Œæˆ")

        except Exception as e:
            logger.error(f"å¤„ç†SNMP Trapæ—¶å‡ºé”™: {e}")
            print(f"âŒ å¤„ç†SNMP Trapå¤±è´¥: {e}")

    
    async def cleanup(self):
        """æ¸…ç†èµ„æº"""
        if self.snmp_receiver:
            await self.snmp_receiver.stop()
            self.snmp_receiver = None
            logger.info("SNMP Trapæ¥æ”¶å™¨å·²æ¸…ç†")